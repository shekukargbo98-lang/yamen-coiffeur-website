// Lightweight i18n loader
// Supports: FR (default), EN, AR (RTL)

(function () {
  const defaultLang = 'fr';
  const supported = ['fr', 'en', 'ar'];
  const select = document.getElementById('langSelect');

  function get(obj, path) {
    return path.split('.').reduce((o, k) => (o && o[k] !== undefined ? o[k] : null), obj);
  }

  function setLanguage(lang) {
    if (!supported.includes(lang)) lang = defaultLang;

    if (select) select.value = lang;

    fetch(`js/translations/${lang}.json`)
      .then(res => res.json())
      .then(trans => {

        // Apply text translations
        document.querySelectorAll('[data-i18n]').forEach(el => {
          const key = el.getAttribute('data-i18n');
          const value = get(trans, key);
          if (value) el.textContent = value;
        });

        // Meta title
        if (trans.meta?.title) {
          document.title = trans.meta.title;
        }

        // Meta description
        if (trans.meta?.description) {
          const metaDesc = document.querySelector('meta[name="description"]');
          if (metaDesc) metaDesc.setAttribute('content', trans.meta.description);
        }

        // Direction & language
        document.documentElement.setAttribute('lang', lang);
        document.documentElement.setAttribute('dir', lang === 'ar' ? 'rtl' : 'ltr');

        // Save choice
        localStorage.setItem('site_lang', lang);
      })
      .catch(err => {
        console.error('i18n load error:', err);
      });
  }

  // Language switcher
  if (select) {
    select.addEventListener('change', e => {
      setLanguage(e.target.value);
    });
  }

  // Initial language
  const stored = localStorage.getItem('site_lang');
  const browserLang = navigator.language?.slice(0, 2);
  const initial = supported.includes(stored)
    ? stored
    : supported.includes(browserLang)
    ? browserLang
    : defaultLang;

  setLanguage(initial);
})();
